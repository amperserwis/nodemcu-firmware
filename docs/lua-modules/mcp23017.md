# Lua MCP23017 Module for NodeMCU / ESP8266

| Since  | Origin / Contributor  | Maintainer  | Source  |
| :----- | :-------------------- | :---------- | :------ |
| 2020-04-10 | [Marcel P.](https://github.com/plomi-net) | [Marcel P.](https://github.com/plomi-net) | [mcp23017.lua](../../lua_modules/mcp23017/mcp23017.lua) |


This Lua module provides access to the MCP23017 module.

The [MCP23017](http://ww1.microchip.com/downloads/en/devicedoc/20001952c.pdf) is a port expander and provides 16 channels for inputs and outputs. 
Up to 8 devices (128 channels) are possible by the configurable address (A0 - A2).

Due to the 16 channels, 2 bytes are required for switching outputs or reading input signals. These are A and B. 
A single pin can be set or a whole byte. 

The numbering of the individual pins starts at 0 and ends with 15.
The numbers up to 7 are on register GPIO A and from 8 to 15 on GPIO B.


!!! important
	The module requires `i2c` and `bit` C module built into firmware.


### Require
```lua
mcp23017 = require("mcp23017")
```

## Example Script
The example script can be found [here](../../lua_examples/mcp23017/mcp23017_example.lua)

## setup()
Configures the interface and sets the i2c pins and the address of the device.
Automatically resets the device state (see `mcp23017.reset()`)

#### Syntax
`mcp23017.setup(address, customSCL, customSDA)`

#### Parameter
- `address` address for MCP23017, default: 0x20 (should be between 0x20 and 0x27)
- `customSCL` Pin for i²c SCL Signal, default: GPIO 5, Pin 1
- `customSDA` Pin for i²c SDA Signal, default: GPIO 4, Pin 2

#### Return
`true` if device found, otherwise `false`.

#### possible Errors
- `MCP23017 device on address not found`
- `MCP23017 address is out of range`

#### Example
```lua
local mcp23017 = require('mcp23017')

local address = 0x20
local cSCL = 1
local cSDA = 2

mcp23017.setup(address, cSCL,cSDA)
```

## setMode()
Set the mode of a single channel. This can be OUTPUT or INPUT.

#### Syntax
`mcp23017.setMode(pin, mode)`

#### Parameter
- `pin` the number to be set for the channel (0-15)
- `mode` the mode for the channel. This can be `mcp23017.INPUT` or `mcp23017.OUTPUT`

#### Return
`true`, in case of error `nil`.

#### Example
```lua
-- set pin 7 and 8 to output (GPA7 and GPB0) and GPB1 to input 
mcp23017.setMode(7, mcp23017.OUTPUT)
mcp23017.setMode(8, mcp23017.OUTPUT)
mcp23017.setMode(9, mcp23017.INPUT)
```

## setPin()
Set the state of a single channel. This can be HIGH or LOW.

#### Syntax
`mcp23017.setMode(pin, state)`

#### Parameter
- `pin` the number to be set for the channel (0-15)
- `state` the state for the channel. This can be `mcp23017.HIGH` or `mcp23017.LOW`

#### Return
`true`, in case of error `nil`.

#### Example
```lua
-- set pin 7 to high (GPA7)
mcp23017.setPin(7, mcp23017.HIGH)
-- set pin 8 to low (GPB0)
mcp23017.setPin(8, mcp23017.LOW)
```

## getPinState()
get the state for a single channel. This can be HIGH or LOW.

#### Syntax
`mcp23017.getPinState(pin)`

#### Parameter
- `pin` the number for which a state is to be queried (0-15)

#### Return
`true` for HIGH, `false` for LOW, in case of error `nil`.

#### Example
```lua
-- get the state for pin 9 (GPB1)
print(mcp23017.getPinState(9))
```

## reset()
By calling this function, a safe state is established. 
All channels are set to input and internal pullup resistors are disabled.
This function can be used for a panic program.

#### Syntax
`mcp23017.reset()`

#### Parameter
None

#### Return
None

#### Example
```lua
-- reset the mcp23017 to startup defaults
mcp23017.reset()
```

## setInternalPullUp()
Enable or disable the internal pullup resistors.
Same for register A and B
Please note that the setting is overwritten with reset()

#### Syntax
`mcp23017.setInternalPullUp(byte)`

#### Parameter
- `byte` byte to set the pullup resistors

#### Return
None

#### Example
```lua
-- enable all pullup resistors
print(mcp23017.setInternalPullUp(0xFF))
-- disable all pullup resistors (default)
print(mcp23017.setInternalPullUp(0x00))
```

## writeIODIRA()
Setup the mode of the channels with a whole byte. In this case for register A.


#### Syntax
`mcp23017.writeIODIRA(byte)`

#### Parameter
- `byte` byte to set the mode for all channels for this register

#### Return
None

#### Example
```lua
-- set all GPA to input
print(mcp23017.writeIODIRA(0xFF))
-- set all GPA to output
print(mcp23017.writeIODIRA(0x00))
```

## writeIODIRB()
Setup the mode of the channels with a whole byte. In this case for register B.
The function is equivalent to `mcp23017.writeIODIRA()`

## writeGPIOA()
Setup the output state of the channels with a whole byte. In this case for register A.

#### Syntax
`mcp23017.writeGPIOA(byte)`

#### Parameter
- `byte` byte to set the state for all channels for this register

#### Return
None

#### Example
```lua
-- set all GPA to HIGH
print(mcp23017.writeGPIOA(0xFF))
-- set all GPA to LOW
print(mcp23017.writeGPIOA(0x00))
```

## writeGPIOB()
Setup the output state of the channels with a whole byte. In this case for register B.
The function is equivalent to `mcp23017.writeGPIOA()`

## readGPIOA()
Read the input states of the channels with a whole byte. In this case for register A.

#### Syntax
`mcp23017.readGPIOA()`

#### Parameter
None

#### Return
byte with states

#### Example
```lua
-- get states for GPA
print(mcp23017.readGPIOA())
```

## readGPIOB()
Read the input states of the channels with a whole byte. In this case for register B.
The function is equivalent to `mcp23017.readGPIOA()`

