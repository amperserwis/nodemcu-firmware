# PWM Module
| Since  | Origin / Contributor  | Maintainer  | Source  |
| :----- | :-------------------- | :---------- | :------ |
| 2019-02-12 | [fikin](https://github.com/fikin) | [fikin](https://github.com/fikin) | [pwm2.c](../../../app/modules/pwm2.c)|

Module to generate PWM impulses to some of GPIO pins.

This module is based on [ESP8266_new_pwm](https://github.com/StefanBruens/ESP8266_new_pwm).

It supports frequencies in the range of 0-5MHz where duty cycle granularity is function of the frequency (see further).

PWM is being generated by software using timer ticks with fixed frequency to control GPIO pins on/off.

It supports 1-13 GPIO pins in any combination at the same time.

Controll loop is using 200ns single timer interrupt period for all pins.
This allows only 1 period (frequency) to be used for all pins.
Also it allows pulse modulation of up to 5MHz (with on/off duty). 

PWM frequency is expressed as count of how many ticks are needed from pulse to pulse.
For example, 1000 ticks make 1kHZ frequency, 1 tick makes 5MHz frequency and so forth.

PWM duty cycle is expressed as count of how many ticks are needed to maintain on-pulse.
For example, with 1kHz frequency there are 5000 ticks between pulses. To form 50% duty cycle one needs 2500 ticks. To form 100% duty cycle one all needs 5000. And to form 0% one needs 0 ticks.

In general terms:
- period is : `period = desired_frequency / 2*10^-7` 
- duty is : `duty = desired_percentage * period / 100`.

Typical usage is as following:
```lua
pwm2.setup_period(5000) -- 1kHZ
pwm2.setup_pin(8, 2500) -- D8 (GPIO15), 50% duty
pwm2.setup_done() -- starts pwm
...
pwm2.set_duty(8, 5000) -- D8, 100%
pwm2.start()
```

**Note:** this module used TIMER1 interrupt. TODO is there impact?

## pwm2.setup_period()
Initialize PWM with given period.

#### Syntax
`pwm2.setup_period(period)`

#### Parameters
`period` 1-5000000

#### Returns
`nil`

#### See also
[pwm.setup_pin()](#setup_pin)

#### See also
[pwm.setup_done()](#setup_done)

## pwm2.setup_pin()
Initialize a pin with given duty.

#### Syntax
`pwm2.setup_pin(pin,duty)`

#### Parameters
`pin` 1~12, IO index
`duty` 0~period, duty cycle

#### Returns
`nil`

#### See also
[pwm2.setup_period()](#setup_period)

#### See also
[pwm.setup_done()](#setup_done)

## pwm.setup_done()
Starts PWM for already setup pins.

#### Syntax
`pwm.setup_done()`

#### Parameters
`nil`

#### Returns
`nil`

#### See also
[pwm.setup_period()](#setup_period)

#### See also
[pwm.setup_pin()](#setup_pin)

## pwm.start()
Takes any duty change to PWM into use.

#### Syntax
`pwm.start()`

#### Parameters
`nil`

#### Returns
`nil`

#### See also
[pwm.set_duty()](#set_duty)

## pwm.set_duty()
Set duty cycle for a pin.

#### Syntax
`pwm.set_duty(pin, duty)`

#### Parameters
- `pin` 1~12, IO index
- `duty` 0~period, pwm duty cycle

#### Returns
`nil`

#### See also
[pwm.start()](#start)

## pwm.get_duty()
Set pin to PWM mode. Only 6 pins can be set to PWM mode at the most.

#### Syntax
`pwm.get_duty(pin)`

#### Parameters
`pin` 1~12, IO index

#### Returns
`duty` 0~period, pwm duty cycle
